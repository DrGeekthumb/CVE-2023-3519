# A hacky boi to find netscalers and look at the last modified date on the HTTP header response
# created by mrr3b00t - inspired by https://twitter.com/DTCERT (thanks!)
# for NetScaler (Citrix ADC) CVE-2023-3519

$ipadd = $args[0]
$target = "https://$ipadd"

$userAgent = [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome

add-type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint srvPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy


try{$scaler = Invoke-WebRequest -Uri $target -Verbose -DisableKeepAlive -UserAgent $userAgent

$found = $scaler.ParsedHtml | findstr -i "citrix"
$found = $scaler.RawContent | findstr -i "citrix"

if($found){

Write-Host " "
Write-Host "CITRIX FOUND" -ForegroundColor Green
Write-Host " "
Write-Host "IP Address: $ipadd"

Write-Host " "
Write-Host "Last modified:"
$scaler.Headers."Last-Modified"
Write-Host " "


if($scaler.Headers."Last-Modified"){
$targetdate = $scaler.Headers."Last-Modified"

$date_str = (Get-Date).ToString('ddd, d MMM yyyy HH:mm:ss', [CultureInfo]'en-gb')

Write-Host "Today's Date:"
$date_str


$ts = New-TimeSpan -Start $date_str -End $targetdate
$diff = $ts.Days
write-host "Days since last update: $diff" -ForegroundColor Cyan
Write-Host " "
if($diff -ge -15){write-host "MIGHT BE OK!"; Write-Host " "}else{write-host "DANGER OLD DATESTAMP DETECTED" -ForegroundColor Red; Write-Host " "}

}else{write-host "Error enumerating" -ForegroundColor Red; Write-Host " "}

}else{write-host "NOT a CITRIX Server" -ForegroundColor Red; Write-Host " "}

}

catch
{
Write-host "Error" -ForegroundColor Red; Write-Host " "
}
