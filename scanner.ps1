# A hacky boi to find netscalers and look at the last modified date on the HTTP header response
# created by mrr3b00t - inspired by https://twitter.com/DTCERT (thanks!)
# for NetScaler (Citrix ADC) CVE-2023-3519


$target = "https://172.26.232.149"

$userAgent = [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome

add-type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint srvPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy


try{$scaler = Invoke-WebRequest -Uri $target -Verbose -DisableKeepAlive -UserAgent $userAgent

$found = $scaler.ParsedHtml | findstr -i "citrix"
$found = $scaler.RawContent | findstr -i "citrix"

if($found){

Write-Host "CITRIX FOUND" -ForegroundColor Green

$target


$scaler.Headers."Last-Modified"


if($scaler.Headers."Last-Modified"){
$targetdate = $scaler.Headers."Last-Modified"

$date_str = (Get-Date).ToString('ddd, d MMM yyyy HH:mm:ss', [CultureInfo]'en-gb')

$date_str


$ts = New-TimeSpan -Start $date_str -End $targetdate
$diff = $ts.Days
write-host "AGE: $diff" -ForegroundColor Cyan
if($diff -ge -15){write-host "MIGHT BE OK!"}else{write-host "DANGER OLD DATESTAMP DETECTED" -ForegroundColor Red}

}else{write-host "Erorr enumerating" -ForegroundColor Red}

}else{write-host "NOT a CITRIX Server" -ForegroundColor Red}

}

catch
{
Write-host "Error" -ForegroundColor Red
}
